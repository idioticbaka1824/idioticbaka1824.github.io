<html>

<head>
    <title>PiyoPiyo Player (soon hopefully)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <style>
        body {
            background-color: #f0f0f0;
            /*d4d0c8*/
            font: normal 12px Verdana, Arial, sans-serif;
        }

        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0
        }

        #toolbar {
            position: absolute;
            flex-wrap: nowrap;
            height: 40px;
            display: flex;
            top: 0;
            left: 0;
            right: 0;
        }

        #toolbar select {
            min-width: 5em;
            max-width: 128px;
            flex: 0 1 auto;
        }

        #canvas-container {
            position: absolute;
            top: 40px;
            bottom: 0;
            left: 0;
            right: 0;
            cursor:url(GUI/cursor.cur), auto;
        }
        
        #table{
            display:table;
            justify-content: center
            width:auto;
            display: inline-block;
            list-style:none;
            padding:0;
            margin:0;
        }
        #table img {
            display:block;
            position:relative;
            margin:0 auto;
        }
        #table li {
        text-align:center;
    }
    </style>
</head>

<body>
    <div id="toolbar">
        <input type="radio" id="dropDownRadio" name="orgSelect" value="dropDownOn" onchange="radioOnChange()" checked>
        <select id="songs" onchange="playOrg('dontPlay')"></select>
        <input type="radio" id="urlInputRadio" name="orgSelect" value="urlInputOn" onchange="radioOnChange()">
        <input type="url" id="idUrlInput" name="nameUrlInput" minlength="2" maxlength="256" size="10" placeholder="Enter URL" disabled>
        
        <div style="padding: 10px;"> </div>
        
        <button onclick="homeOrg()"><img src="GUI/org_home.png" alt="Home"></button>
        <div style="padding: 5px;"> </div>
        <button onclick="backMeas()"><img src="GUI/org_back.png" alt="Back"></button>
        <button onclick="nextMeas()"><img src="GUI/org_next.png" alt="Next"></button>
        <button onclick="playOrg()"><img src="GUI/org_play.png" alt="Play"></button>
        <button onclick="pauseOrg()"><img src="GUI/org_stop.png" alt="Stop"></button>
        <!-- <button onclick="stopOrg()">Stop</button> -->
        
        <label style="display: flex;align-items: center;padding-top: 5px;padding-bottom: 5px;padding-left: 20px;padding-right: 0px;">Meas</label>
        <div style="display: flex;align-items: center;padding:4px;">
            <label id="currentMeasDisplay" style="display: flex;align-items: center;justify-content: center;box-shadow: inset 1px 1px 3px #999;border: 1px solid #555;padding: 5px;width: 2em">0</label>
            <div style="padding: 2px;"> </div>
            <label id="currentStepDisplay" style="display: flex;align-items: center;justify-content: center;box-shadow: inset 1px 1px 3px #999;border: 1px solid #555;padding: 5px;width: 2em">0</label>
        
            <label style="display: flex;align-items: center;padding-top: 5px;padding-bottom: 5px;padding-left: 25px;padding-right: 4px;">Track</label>
            <label id="currentTrackDisplay" style="display: flex;align-items: center;justify-content: center;box-shadow: inset 1px 1px 3px #999;border: 1px solid #555;padding: 5px;width: 1em">1</label>
            <label style="display: flex;align-items: center;padding-top: 5px;padding-bottom: 5px;padding-left: 10px;padding-right: 4px;">Wait</label>
            <label id="currentWaitDisplay" style="display: flex;align-items: center;justify-content: center;box-shadow: inset 1px 1px 3px #999;border: 1px solid #555;padding: 5px;width: 2em">0</label>
        </div>
        
            <div style="padding: 10px;"></div>
            <label style="display: flex;align-items: center;padding-top: 5px;padding-bottom: 5px;padding-left: 0px;padding-right: 4px;">Mute</label>
            <div id="table">
                <li><img src="GUI/button_track_1.png"/></li>
                <li><input type="checkbox" value="0" id="mute_1" name="is1Muted" class="mute"/></li>
            </div>
            <div id="table">
                <li><img src="GUI/button_track_2.png"/></li>
                <li><input type="checkbox" value="1" id="mute_2" name="is2Muted" class="mute"/></li>
            </div>
            <div id="table">
                <li><img src="GUI/button_track_3.png"/></li>
                <li><input type="checkbox" value="2" id="mute_3" name="is3Muted" class="mute"/></li>
            </div>
            <button onclick="muteAll('melodies')" style="height:38px;padding:2px;"></button>
            
                <div style="padding:5px;"></div>
                
            <div id="table">    
                <li><img src="GUI/button_track_Q.png"/></li>
                <li><input type="checkbox" value="3" id="mute_P" name="isPMuted" class="mute"/></li>
            </div>
    
        <div style="padding:10px;"></div>
        <button onclick="muteAll('solo')"><img src="GUI/solo.png" alt="Solo"></button>
    </div>
            
    <div id="canvas-container">
        <canvas id="org-canvas"></canvas>
		<!-- <canvas id="org-canvas2"></canvas> -->
    </div>

    <!-- increment before each deploy -->
    <script src="organya.js?cache_bust=12"></script>
    <script src="organya-ui.js?cache_bust=12"></script>
    <!--I have no clue what this cache bust thing is, but apparently it's needed to reflect updates properly-->
    <script>
    
        let prev_song=null;
        let new_song=null;
        
        (() => {
            const songs = `Azarashi.pmd
			Test.pmd
			Testnote-Ikachan.pmd
			ikachan/Ikachan.pmd
			ikachan/Buriki.pmd
			ikachan/Magirete.pmd
			ikachan/Mizuno.pmd
			ikachan/Quake.pmd
			ikachan/Tidepool.pmd
			examples/Sample1.pmd
			examples/Doggy1.pmd
			examples/Iron.pmd
			data/Dark.pmd
			data/BrokenToy.pmd
			data/ZaomiZaomi.pmd`.split("\n").sort();

            const songListEl = document.getElementById("songs");
            for (let song of songs) {
                song = song.trim();
                const opt = document.createElement("option");
                opt.value = "songs/" + song;
                opt.textContent = song;

                songListEl.appendChild(opt);
            }

            const canvasContainer = document.getElementById("canvas-container");
            const orgCanvas = document.getElementById("org-canvas");
            orgCanvas.width = canvasContainer.clientWidth;
            orgCanvas.height = canvasContainer.clientHeight;
			orgCanvas.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); } //disabling context menu on the canvas so that right-click can be used for other stuff
            const ui = new OrganyaUI(orgCanvas);

            window.addEventListener("resize", () => {
                orgCanvas.width = Math.max(canvasContainer.clientWidth, 640); //minimum size is 640x480, otherwise things can started crowding into each other
                orgCanvas.height = Math.max(canvasContainer.clientHeight, 480);
                ui.draw();
            })
            
            window.radioOnChange = () => {
                if(document.getElementById('dropDownRadio').checked){
                    document.getElementById('songs').disabled=false;
                    document.getElementById('idUrlInput').disabled=true;
                    playOrg('doNotPlay');
                }
                else{
                    document.getElementById('songs').disabled=true;
                    document.getElementById('idUrlInput').disabled=false;
                }
            }

            let currentOrg = null;
            window.stopOrg = () => {
                if (currentOrg != null) {
                    currentOrg.stop();
                    currentOrg = null;
                }
            }
	    
            window.pauseOrg = () => {
                if (currentOrg != null) {
                    currentOrg.pause();
                    prev_song = songListEl.options[songListEl.selectedIndex].value;
                }
            }

            window.playOrg = async (argument='doPlay') => {
                console.log("fetching song...");
                if(document.getElementById('dropDownRadio').checked){
					songname = songListEl.options[songListEl.selectedIndex].value;
					songname = "https://raadshaikh.github.io/music/piyopiyo-js/" + songname
					songname = new URL(songname);
                    res = await fetch(songname);
					prev_song = new_song;
                    new_song = songListEl.options[songListEl.selectedIndex].value;
                }
                else if(document.getElementById('urlInputRadio').checked){
                    res = await fetch(document.getElementById('idUrlInput').value);
					prev_song = new_song;
                    new_song = document.getElementById('idUrlInput').value;
                }
                if (prev_song != new_song || prev_song == null){
                    stopOrg();
					<!-- if (argument!='doPlay'){ -->
						<!-- shouldUnMuteAll=1; //this doesn't quite work the way i want -->
						<!-- window.muteAll('solo'); -->
					<!-- } -->
                    const data = await res.arrayBuffer();
                    await initOrganya();

                    currentOrg = new Organya(data);
                    ui.setOrganya(currentOrg);
                    currentWaitDisplay.innerHTML=currentOrg.song.wait;
                    currentOrg.update();
                }
                currentOrg.play(argument);
            }
            
            window.homeOrg = () => {
                if (currentOrg != null) {
                    currentOrg.homeOrg();
                    prev_song = songListEl.options[songListEl.selectedIndex].value; //didn't have this earlier, but it fixes a bug where playing, placing new notes, then clicking home and then playing will erase your changes
                }
            }
            window.backMeas = () => {
                if (currentOrg != null) {
                    currentOrg.backMeas();
                }
            }
            window.nextMeas = () => {
                if (currentOrg != null) {
                    currentOrg.nextMeas();
                }
            }
            window.updown = (argument) => {
                const scrollAmount = -64*(Number(argument=='up')-Number(argument=='down'));
                ui.onScroll({ deltaY: scrollAmount });
            }
            
            let muteMelodies=['mute_1','mute_2','mute_3'];
            let muteDrums=['mute_P'];
            let muteAll=muteMelodies.concat(muteDrums);
            let shouldUnMuteAll=0;
            window.muteAll = (argument) => {
                let toMute=[];
                if (argument=='melodies'){
                    toMute = muteMelodies;
                }
                else if (argument=='drums') {
                    toMute = muteDrums;
                }
                else if (argument=='solo'){
                    toMute=muteAll.slice(); //to copy arrays
                    unMute='mute_'+currentTrackDisplay.innerHTML;
                    toMute.splice(toMute.indexOf(unMute), 1);
                }
				if(shouldUnMuteAll==0){
					for (var i in toMute) {
                        document.getElementById(toMute[i]).checked=true;
                    }
                    if(argument=='solo') document.getElementById(unMute).checked=null;
				}
                else if (shouldUnMuteAll==1){
					for (var i in muteAll) {
                        document.getElementById(muteAll[i]).checked=null;
                    }
                }
                shouldUnMuteAll=1-shouldUnMuteAll;
            }
            
            
            let allowedTracks=['1','2','3','4','p']
			var keyBeingPressed=null;
            document.addEventListener('keyup', (e) => {
				keyBeingPressed=null;
				console.log(keyBeingPressed);
			}, true);
            document.addEventListener('keydown', (e) => {
					keyBeingPressed = e.key;
					console.log(keyBeingPressed);
                    if(currentOrg!=null && allowedTracks.includes(e.key)){
						if(currentOrg.selectedTrack!=allowedTracks.indexOf(e.key)) shouldUnMuteAll=1-shouldUnMuteAll;
                        currentTrackDisplay.innerHTML = e.key == 4 ? 'P' : e.key.toUpperCase(); //both '4' and 'p' are accepted names for the drum track, but it should display 'p'
                        currentOrg.selectedTrack = allowedTracks.indexOf(e.key)
						if (e.key=='p') currentOrg.selectedTrack = 3;
                        currentOrg.update();
                    }
                    else if(e.key=="ArrowLeft"){
                        window.backMeas();
                    }
                    else if(e.key=="ArrowRight"){
                        window.nextMeas();
                    }
                    else if(e.key=="ArrowUp"){
                        window.updown('up');
                    }
                    else if(e.key=="ArrowDown"){
                        window.updown('down');
                    }
                    else if(e.key==" "){
                        if(currentOrg.isPlaying==false) window.playOrg();
                        else if(currentOrg.isPlaying==true) window.pauseOrg();
                    }
                    else if(e.key=="Home"){
                        window.homeOrg();
                    }
                    else if(e.key=="Delete" || e.key=="Backspace"){
                        currentOrg.deleteNotes();
                    }
                    else if(e.ctrlKey && e.key=='c'){
                        currentOrg.changeEditingMode(1);
						currentOrg.copyNotes();
                    }
					else if(e.ctrlKey && e.key=='v'){
                        currentOrg.pasteNotes(-1, -1);
                    }
					else if(e.key=='Tab'){
                        //currentOrg.changeEditingMode(1-currentOrg.editingMode); //
						//if(currentOrg.editingMode==1) currentOrg.copyNotes(); //this would make it toggle modes
                        currentOrg.changeEditingMode(0); //this just sets pencil mode
                    }
					else if(e.key=='Enter'){
						currentOrg.toggleWaveformEditor();
					}
					else if(e.key=='s'){
						window.muteAll('solo');
					}
					else if(e.key=='m' && currentOrg!=null){
						mute_string='mute_'+currentTrackDisplay.innerHTML;
						mute_element = document.getElementById(mute_string);
						mute_element.checked = 1-mute_element.checked;
					}
					<!-- else if(e.key=='q'){ -->
						<!-- window.helpHandling(cursor_coords[0], cursor_coord[1]); -->
					<!-- } -->
                
            }, true);
			
			
			function getMousePosition(canvas, event) {
            let rect = canvas.getBoundingClientRect();
            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;
            return [x, y];
			}
			
			orgCanvas.addEventListener('mousedown', (e) => {
                click_coords = getMousePosition(orgCanvas, e);
				window.clickHandling(click_coords[0], click_coords[1], e=e);
            }, true);
            
			var isSelecting = false;
			var isEditingSamples = false;
			var cursor_coords = [0,0];
			
			window.clickHandling = (x, y, e) => {
				if(currentOrg != null) {
					if(y>=orgCanvas.height-84-16-76 && y<=orgCanvas.height-84-76 && x>36+8) {
						currentOrg.cursorUpdate(x-8); 
						if (currentOrg.editingMode==0) isSelecting=true;
					}
					if(y>16 && y<orgCanvas.height-84-16-76 && x>36+8) {
						if (currentOrg.editingMode==0) currentOrg.addNote(x-8, y, ui.scrollY);
						else if (currentOrg.editingMode==1) currentOrg.pasteNotes(x-8, y);
					}
					if(y>orgCanvas.height-84-76 && y<orgCanvas.height-76 && x>36+8) {
						if(!keyBeingPressed=='q') currentOrg.addPan(x-8, y, orgCanvas.height);
						else {console.log(x,y);}
					}
					if(y>orgCanvas.height-76 && y<orgCanvas.height-60 && x<256) currentOrg.changeTrack(x, e.button); //left/right click either select or mutes a track. i'll handle both of these with the same function
					if(y>orgCanvas.height-76 && y<orgCanvas.height-48 && x>orgCanvas.width-144 && x<orgCanvas.width-144+48) homeOrg();
					if(y>orgCanvas.height-76 && y<orgCanvas.height-48 && x>orgCanvas.width-144+48 && x<orgCanvas.width-144+2*48) playOrg();
					if(y>orgCanvas.height-76 && y<orgCanvas.height-48 && x>orgCanvas.width-144+2*48 && x<orgCanvas.width-144+3*48) pauseOrg();
					if(y>orgCanvas.height-48 && y<orgCanvas.height-24 && x>orgCanvas.width-144+2*48 && x<orgCanvas.width-144+3*48) currentOrg.deleteNotes();
					if(y>orgCanvas.height-48 && y<orgCanvas.height-24 && x>orgCanvas.width-144 && x<orgCanvas.width-144+48) currentOrg.changeEditingMode(0);
					if(y>orgCanvas.height-48 && y<orgCanvas.height-24 && x>orgCanvas.width-144+48 && x<orgCanvas.width-144+2*48) {currentOrg.changeEditingMode(1); currentOrg.copyNotes();};
					if(y>orgCanvas.height-72 && y<orgCanvas.height-72+32 && x>orgCanvas.width-144-8-32 && x<orgCanvas.width-144-8) currentOrg.changeLoop();
					if(y>orgCanvas.height-72+32 && y<orgCanvas.height-72+64 && x>orgCanvas.width-144-8-32 && x<orgCanvas.width-144-8) currentOrg.changeLowSpec();
					if(!currentOrg.isWaveformEditor && y>orgCanvas.height-24 && y<orgCanvas.height && x>orgCanvas.width-144 && x<orgCanvas.width-144+48) currentOrg.toggleWaveformEditor();
					if(currentOrg.isWaveformEditor && y>orgCanvas.height-24 && y<orgCanvas.height && x>orgCanvas.width-48 && x<orgCanvas.width) currentOrg.toggleWaveformEditor();
					if(currentOrg.isWaveformEditor && y>274 && y<274+120 && x>64 && x<64+120) currentOrg.updateNoteIcon(x, y);
					if (currentOrg.isWaveformEditor && cursor_coords[0]>64 && cursor_coords[0]<64+512 && cursor_coords[1]>56 && cursor_coords[1]<56+200) isEditingSamples=true;
					if (currentOrg.isWaveformEditor && cursor_coords[0]>320 && cursor_coords[0]<320+256 && cursor_coords[1]>274 && cursor_coords[1]<274+128) isEditingSamples=true;
				}
			}
			
			orgCanvas.addEventListener('mousemove', (e) => {
                cursor_coords = getMousePosition(orgCanvas, e);
				if (currentOrg != null) {
					if (!currentOrg.isWaveformEditor && cursor_coords[0]>orgCanvas.width-8 && cursor_coords[1]<orgCanvas.height-74 && currentOrg.isPlaying==false) window.nextMeas();
					if (!currentOrg.isWaveformEditor && cursor_coords[0]<8 && cursor_coords[1]<orgCanvas.height-74 && currentOrg.isPlaying==false) window.backMeas();
					if (isSelecting) currentOrg.selectionUpdate(cursor_coords[0]);
					if (isEditingSamples && currentOrg.isWaveformEditor && cursor_coords[0]>64 && cursor_coords[0]<64+512 && cursor_coords[1]>56 && cursor_coords[1]<56+200) currentOrg.editWaveSamples(cursor_coords[0], cursor_coords[1]);
					if (isEditingSamples && currentOrg.isWaveformEditor && cursor_coords[0]>320 && cursor_coords[0]<320+256 && cursor_coords[1]>274 && cursor_coords[1]<274+128) currentOrg.editEnvelopeSamples(cursor_coords[0], cursor_coords[1]);
				}
			}, true);
			
			orgCanvas.addEventListener('mouseup', (e) => {
				isSelecting = false;
				isEditingSamples = false;
                //cursor_coords = getMousePosition(orgCanvas, e);
				//if (currentOrg!=null && cursor_coords[0]>orgCanvas.width-8) window.nextMeas();
				//if (currentOrg!=null && cursor_coords[0]<8) window.backMeas();
            }, true);
            
        })();
    </script>
</body>

</html>